/* 
* SSD1306.cpp
*
* Created: 30.05.2018 19:34:55
* Author: dominik hellhake
*/


#include "SSD1306.h"

uint8_t SSD1306::FrameBuffer[513] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// default constructor
SSD1306::SSD1306()
{
} //SSD1306

void SSD1306::Init()
{
	uint8_t cmd_buff[2] = {0x00, 0x00};
	
	/* Init I2C peripheral */
	I2C::InitSERCOM();
	
	/* DISPLAYOFF */
	cmd_buff[1] = 0xAE;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* SETDISPLAYCLOCKDIV */
	cmd_buff[1] = 0xD5;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x80;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* SETMULTIPLEX */
	cmd_buff[1] = 0xA8;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 32 - 1;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();

	/* SETDISPLAYOFFSET */
	cmd_buff[1] = 0xD3;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x00;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* SETSTARTLINE */
	cmd_buff[1] = 0x40 | 0x0;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* CHARGEPUMP */
	cmd_buff[1] = 0x8D;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x14;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* MEMORYMODE */
	cmd_buff[1] = 0x20;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x00;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* SEGREMAP */
	cmd_buff[1] = 0xA0 | 0x1;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* COMSCANDEC */
	cmd_buff[1] = 0xC8;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();

	/* SETCOMPINS */
	cmd_buff[1] = 0xDA;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x02;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* SETCONTRAST */
	cmd_buff[1] = 0x81;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x8F;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* SETPRECHARGE */
	cmd_buff[1] = 0xD9;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0xF1;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* SETVCOMDETECT */
	cmd_buff[1] = 0xDB;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x40;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* DISPLAYALLON_RESUME */
	cmd_buff[1] = 0xA4;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* NORMALDISPLAY */
	cmd_buff[1] = 0xA6;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();

	/* DEACTIVATE_SCROLL */
	cmd_buff[1] = 0x2E;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	
	/* DISPLAYON */
	cmd_buff[1] = 0xAF;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
}

void SSD1306::Update()
{
	uint8_t cmd_buff[2] = {0x00, 0x00};
		
	/* COLUMNADDR */
	cmd_buff[1] = 0x21;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x00;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 128-1;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();

	/* PAGEADDR */
	cmd_buff[1] = 0x22;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x00;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
	cmd_buff[1] = 0x03;
	I2C::StartTransmitt(SLAVE_ADDR, cmd_buff, 2);
	I2C::Wait();
		
	SSD1306::FrameBuffer[0] = 0x40;
		
	I2C::StartTransmitt(SLAVE_ADDR, SSD1306::FrameBuffer, 513);
	I2C::Wait();
}

void SSD1306::WriteChar16(uint8_t *chr)
{
	uint8_t index = 1;
	for (uint8_t x = 1; x < 32; x += 2)
	{
		SSD1306::FrameBuffer[index] = ~chr[x];
		index++;
	}
	index = 129;
	
	for (uint8_t x = 0; x < 32; x += 2)
	{
		SSD1306::FrameBuffer[index] = ~chr[x];
		index++;
	}
}

// default destructor
SSD1306::~SSD1306()
{
} //~SSD1306
